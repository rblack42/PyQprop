

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>gvcalc.f &#8212; PyQpro</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"jax": ["input/TeX", "output/HTML-CSS"], "displayAlign": "left", "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'qprop/gvcalc_f';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="spline.f" href="spline_f.html" />
    <link rel="prev" title="cdfun.f" href="cdfun_f.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/lpp.gif" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/lpp.gif" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Refactoring Mark Drela’s Tools
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="qprop.html">QPROP: Propeller Analysis Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="qprop-algorithms.html">QProp Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="qprop_f.html">qprop.f</a></li>
<li class="toctree-l1"><a class="reference internal" href="qcget_f.html">qcget.f</a></li>
<li class="toctree-l1"><a class="reference internal" href="tqcalc_f.html">tqcalc.f</a></li>
<li class="toctree-l1"><a class="reference internal" href="cdfun_f.html">cdfun.f</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">gvcalc.f</a></li>
<li class="toctree-l1"><a class="reference internal" href="spline_f.html">spline.f</a></li>
<li class="toctree-l1"><a class="reference internal" href="io_f.html">io.f</a></li>
<li class="toctree-l1"><a class="reference internal" href="bnsolv_f.html">bnsolv.f</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/rblack42/math-magik-drela" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/rblack42/math-magik-drela/issues/new?title=Issue%20on%20page%20%2Fqprop/gvcalc_f.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/qprop/gvcalc_f.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>gvcalc.f</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psi-iteration">Psi Iteration</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="gvcalc-f">
<h1>gvcalc.f<a class="headerlink" href="#gvcalc-f" title="Permalink to this heading">#</a></h1>
<p>This routine is the heart of the propeller performance calculation. The theory behind
the calculations in this routine can be found in the <strong>qprop_theory.txt</strong> file
available on the <em>QProp</em> website* [Qprop
Theory]https://web.mit.edu/drela/Public/web/qprop/qprop_theory.pdf().</p>
<p>Here are the input parameters:</p>
<div class="highlight-fortranfixed notranslate"><div class="highlight"><pre><span></span><span class="c">C  Input   CHORD   local blade chord</span>
<span class="c">C          BETA    local blade angle  (radians)</span>
<span class="c">C          R       local radius</span>
<span class="c">C</span>
<span class="c">C          BLDS    number of blades</span>
<span class="c">C          RAD     tip radius  (for Prandtl&#39;s factor)</span>
<span class="c">C          VEL     forward flight speed</span>
<span class="c">C          OMG     rotational speed  (radians/time)</span>
<span class="c">C          VSO     speed of sound</span>
<span class="c">C</span>
<span class="c">C          CL0     constants for CL(alpha,M) function</span>
<span class="c">C          DCLDA</span>
<span class="c">C          CLMIN</span>
<span class="c">C          CLMAX</span>
<span class="c">C          MCRIT</span>
</pre></div>
</div>
<p>The output parameters are listed next:</p>
<div class="highlight-fortranfixed notranslate"><div class="highlight"><pre><span></span><span class="c">C  Output  GAM     circulation</span>
<span class="c">C          VA      axial induced velocity</span>
<span class="c">C          VT      tangential induced velocity</span>
<span class="c">C          CL      section lift coefficient</span>
<span class="c">C          STALL   T if alpha is outside stall limits</span>
<span class="c">C          LCONV   F if iteration did not converge</span>
<span class="c">C</span>
<span class="c">C          ()_VEL  derivatives  d()/dVEL</span>
<span class="c">C          ()_OMG  derivatives  d()/dOMG</span>
<span class="c">C          ()_CH   derivatives  d()/dCHORD</span>
<span class="c">C          ()_BE   derivatives  d()/dBETA</span>
</pre></div>
</div>
<p>From the theory doc, here are two figures that detail the velocity conponents
around a section of the propeller at a radius <strong>R</strong> from the axis:</p>
<a class="reference internal image-reference" href="../_images/qprop-figure1a.png"><img alt="../_images/qprop-figure1a.png" src="../_images/qprop-figure1a.png" style="width: 400px;" /></a>
<a class="reference internal image-reference" href="../_images/qprop-figure1b.png"><img alt="../_images/qprop-figure1b.png" src="../_images/qprop-figure1b.png" style="width: 400px;" /></a>
<p>In these figures, these equations hold:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}W_a = V + u_a + v_a\\W_t = \Omega r -u_t -v_t\\W = \sqrt{W_a^2 + W_t^2}\end{aligned}\end{align} \]</div>
<p>Where:</p>
<ul class="simple">
<li><p><strong>V</strong> is the free-stream velocity (<strong>VEL</strong>)</p></li>
<li><p><strong>r</strong> is the radial position of the blade section</p></li>
<li><p><span class="math notranslate nohighlight">\(\Omega\)</span> is the rotation rate of the propeller (<strong>OMG</strong>)</p></li>
</ul>
<p>For our rubber powered models the values of <span class="math notranslate nohighlight">\(u_q\)</span> ns <span class="math notranslate nohighlight">\(u_t\)</span> are bith
zero since they are related to  possible  upstream systems, like counter
rotating propellers.</p>
<p>The calculations are carried out for one specific radial position specified by
the input <strong>R</strong> value. That means this routine will be called for each radial
position ot complete the propeller analysis.</p>
<section id="psi-iteration">
<h2>Psi Iteration<a class="headerlink" href="#psi-iteration" title="Permalink to this heading">#</a></h2>
<p>The basic logic incolved performing a <em>Newton’s Iteration</em> to find the value of
“math”<cite>Psi</cite> for this radial position. The input data provides the needed
aerodynamic properties for the blade at this location.</p>
<p><em>Newton’s method</em> assumes the existence of a function the describes the property
needed (:math::<cite>Psi</cite>). We are interested in calculating the value of this
function at a specified value of he dependent variable. We start with an
initial guess for the solution and calculate the next solution based on the ratio of the function and its derivative at that initial point. The solution proceeds by repeating this calculation using the first result as the next guess. If the function is smooth and the initial guess is close enough, this scheme converges quickly.
guess. Here is the scheme:</p>
<div class="math notranslate nohighlight">
\[x_1 = x_0 + \frac{f(x_o)}{f^`(x_0)}\]</div>
<p>Successive guesses follow the same pattern:</p>
<div class="math notranslate nohighlight">
\[x_{n_1} = x_n + \frac{f(x_n)}{f^`(x_n)}\]</div>
<p>The nitial guess is set as the maximum of these two values:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\Psi_1 &amp;= atan2(u_a, u_t) \\
\Psi_2 &amp;= \beta + Cl_0/DCLDA\end{split}\]</div>
<p>Here is the complete source file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>C***********************************************************************
C    Module:  gvcalc.f
C 
C    Copyright (C) 2003 Mark Drela 
C 
C    This program is free software; you can redistribute it and/or modify
C    it under the terms of the GNU General Public License as published by
C    the Free Software Foundation; either version 2 of the License, or
C    (at your option) any later version.
C
C    This program is distributed in the hope that it will be useful,
C    but WITHOUT ANY WARRANTY; without even the implied warranty of
C    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
C    GNU General Public License for more details.
C
C    You should have received a copy of the GNU General Public License
C    along with this program; if not, write to the Free Software
C    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
C***********************************************************************

      SUBROUTINE GVCALC(CHORD,BETA,R,
     &amp;                BLDS,RAD,VEL,OMG,VSO,
     &amp;                CL0,DCLDA,CLMIN,CLMAX,MCRIT,
     &amp;                GAM,GAM_VEL,GAM_OMG,GAM_CH,GAM_BE,
     &amp;                 VA, VA_VEL, VA_OMG, VA_CH, VA_BE,
     &amp;                 VT, VT_VEL, VT_OMG, VT_CH, VT_BE,
     &amp;                 CL, CL_VEL, CL_OMG, CL_CH, CL_BE, STALL, LCONV)
      IMPLICIT REAL (A-H,M,O-Z)
      LOGICAL STALL, LCONV
C--------------------------------------------------------------
C     Computes circulation and related section properties
C     at one radial station.  Uses local circulation/swirl
C     relation with a modified Prandtl&#39;s tip fudge factor.  
C     Does not make light-loading approximations, and 
C     is consistent with actuator disk theory in the limit 
C     of zero forward velocity.
C
C  Input   CHORD   local blade chord
C          BETA    local blade angle  (radians)
C          R       local radius
C
C          BLDS    number of blades
C          RAD     tip radius  (for Prandtl&#39;s factor)
C          VEL     forward flight speed
C          OMG     rotational speed  (radians/time)
C          VSO     speed of sound
C
C          CL0     constants for CL(alpha,M) function
C          DCLDA
C          CLMIN
C          CLMAX
C          MCRIT
C
C  Output  GAM     circulation
C          VA      axial induced velocity
C          VT      tangential induced velocity
C          CL      section lift coefficient
C          STALL   T if alpha is outside stall limits
C          LCONV   F if iteration did not converge
C
C          ()_VEL  derivatives  d()/dVEL
C          ()_OMG  derivatives  d()/dOMG
C          ()_CH   derivatives  d()/dCHORD
C          ()_BE   derivatives  d()/dBETA
C--------------------------------------------------------------
C
      DATA PI / 3.14159265 /
      DATA EPS / 1.0E-6 /
cc      DATA EPS / 1.0E-10 /
C
      DATA MSQMAX    / 0.9    /
C
C---- perturbation imposed axial and tangential velocities
      U0A = 0.
      U0T = 0.
C
C---- total imposed axial and tangential velocities
      UA     = VEL   + U0A
      UA_VEL = 1.0
      UA_U0A =         1.0
C
      UT     = OMG*R - U0T
      UT_OMG =     R
      UT_U0T =       - 1.0
C
C---- geometric velocity
      WZ = SQRT(UA**2 + UT**2)
      WZ_VEL = (UA/WZ)*UA_VEL
      WZ_OMG = (UT/WZ)*UT_OMG
C
C---- initial guess for Newton variable PSI
      PSI1 = ATAN2(UA,UT)
      PSI2 = BETA + CL0/DCLDA
      PSI = MAX( PSI1 , PSI2 )
C
C---- Newton iteration for actual PSI
      LCONV = .FALSE.
      DO ITER = 1, 20
        COSP = COS(PSI)
        SINP = SIN(PSI)
C
C------ total axial and tangential velocities
        WA     = 0.5*UA     + 0.5*WZ    *SINP
        WA_PSI =              0.5*WZ    *COSP
        WA_VEL = 0.5*UA_VEL + 0.5*WZ_VEL*SINP
        WA_OMG =              0.5*WZ_OMG*SINP
C
        WT     = 0.5*UT     + 0.5*WZ    *COSP
        WT_PSI =            - 0.5*WZ    *SINP
        WT_VEL =              0.5*WZ_VEL*COSP
        WT_OMG = 0.5*UT_OMG + 0.5*WZ_OMG*COSP
C
C------ modified Prandtl&#39;s F function
        IF(WA.EQ.0.0) THEN
         F     = 1.0
         F_PSI = 0.
         F_VEL = 0.
         F_OMG = 0.
C
         ADW     = 0.
         ADW_PSI = 0.
         ADW_VEL = 0.
         ADW_OMG = 0.
C
        ELSE
         TSR = WT/WA * RAD/R
         TSR_PSI = (WT_PSI * RAD/R - TSR*WA_PSI)/WA
         TSR_VEL = (WT_VEL * RAD/R - TSR*WA_VEL)/WA
         TSR_OMG = (WT_OMG * RAD/R - TSR*WA_OMG)/WA
C
         FARG     = 0.5*BLDS*(1.0-R/RAD)*TSR
         FARG_TSR = 0.5*BLDS*(1.0-R/RAD)
         FARG = MIN( FARG , 20.0 )
C
         FEXP = EXP(-FARG)
         FEXP_TSR = -FEXP*FARG_TSR
C
         F = (2.0/PI) * ACOS(FEXP)
         F_TSR = -(2.0/PI) / SQRT(1.0 - FEXP**2) * FEXP_TSR
C
         F_PSI = F_TSR*TSR_PSI
         F_VEL = F_TSR*TSR_VEL
         F_OMG = F_TSR*TSR_OMG
C
         ADW     =  1.0    /TSR
         ADW_PSI = -TSR_PSI/TSR**2
         ADW_VEL = -TSR_VEL/TSR**2
         ADW_OMG = -TSR_OMG/TSR**2
C
        ENDIF
C
C------ axial and tangential induced velocities
        VA     = WA     - UA
        VA_PSI = WA_PSI
        VA_VEL = WA_VEL - UA_VEL
        VA_OMG = WA_OMG
C
        VT     = UT     - WT
        VT_PSI =        - WT_PSI
        VT_VEL =        - WT_VEL
        VT_OMG = UT_OMG - WT_OMG
C
C------ circulation
        QBI = 4.0/BLDS
        PIR = SQRT((PI*R)**2 + (QBI*RAD*ADW)**2)
        PIR_ADW = (QBI*RAD)**2*ADW/PIR
        PIR_PSI = PIR_ADW*ADW_PSI
        PIR_VEL = PIR_ADW*ADW_VEL
        PIR_OMG = PIR_ADW*ADW_OMG
C
        GAM     = QBI* F*VT                *PIR
        GAM_PSI = QBI*(F*VT_PSI + F_PSI*VT)*PIR + QBI*F*VT*PIR_PSI
        GAM_VEL = QBI*(F*VT_VEL + F_VEL*VT)*PIR + QBI*F*VT*PIR_VEL
        GAM_OMG = QBI*(F*VT_OMG + F_OMG*VT)*PIR + QBI*F*VT*PIR_OMG
C
C------ total velocity
        WSQ = WA**2 + WT**2
        W = SQRT(WSQ)
        W_PSI = (WA*WA_PSI + WT*WT_PSI)/W
        W_VEL = (WA*WA_VEL + WT*WT_VEL)/W
        W_OMG = (WA*WA_OMG + WT*WT_OMG)/W
C
C------ angle of attack
        A = BETA - ATAN2(WA,WT)
        A_PSI = (-WT*WA_PSI + WA*WT_PSI)/WSQ
        A_VEL = (-WT*WA_VEL + WA*WT_VEL)/WSQ
        A_OMG = (-WT*WA_OMG + WA*WT_OMG)/WSQ
        A_BE  = 1.0
C
C------ local Mach and PG factor
        MSQ = WSQ / VSO**2
        MSQ_PSI = 2.0*W*W_PSI / VSO**2
        MSQ_VEL = 2.0*W*W_VEL / VSO**2
        MSQ_OMG = 2.0*W*W_OMG / VSO**2
        IF(MSQ .GT. MSQMAX) THEN
         MSQ = MSQMAX
         MSQ_PSI = 0.
         MSQ_VEL = 0.
         MSQ_OMG = 0.
        ENDIF
C
        PG = 1.0 / SQRT(1.0 - MSQ)
        PG_MSQ = 0.5*PG / (1.0 - MSQ)
C
        PG_PSI = PG_MSQ*MSQ_PSI
        PG_VEL = PG_MSQ*MSQ_VEL
        PG_OMG = PG_MSQ*MSQ_OMG
C
C------ CL(alpha,Mach) function
        CL     = (DCLDA*A + CL0)*PG
        CL_PSI =  DCLDA*A_PSI   *PG + (DCLDA*A + CL0)*PG_PSI 
        CL_VEL =  DCLDA*A_VEL   *PG + (DCLDA*A + CL0)*PG_VEL 
        CL_OMG =  DCLDA*A_OMG   *PG + (DCLDA*A + CL0)*PG_OMG 
        CL_BE  =  DCLDA*A_BE    *PG   
C                      
        STALL = .FALSE.
        IF    (CL.GT.CLMAX) THEN
         STALL = .TRUE.
         ACL0 = CL0/DCLDA
C
         CL   =  CLMAX*COS(A-ACL0)
         CL_A = -CLMAX*SIN(A-ACL0)
C
         CL_PSI = CL_A*A_PSI
         CL_VEL = CL_A*A_VEL
         CL_OMG = CL_A*A_OMG
         CL_BE  = CL_A*A_BE
        ELSEIF(CL.LT.CLMIN) THEN
         STALL = .TRUE.
         ACL0 = CL0/DCLDA
C
         CL   =  CLMIN*COS(A-ACL0)
         CL_A = -CLMIN*SIN(A-ACL0)
C
         CL_PSI = CL_A*A_PSI
         CL_VEL = CL_A*A_VEL
         CL_OMG = CL_A*A_OMG
         CL_BE  = CL_A*A_BE
        ENDIF
C
C------ Newton residual
        RES     = GAM     - 0.5*CHORD* CL*W
        RES_PSI = GAM_PSI - 0.5*CHORD*(CL*W_PSI + CL_PSI*W)
        RES_VEL = GAM_VEL - 0.5*CHORD*(CL*W_VEL + CL_VEL*W)
        RES_OMG = GAM_OMG - 0.5*CHORD*(CL*W_OMG + CL_OMG*W)
        RES_CH  =         - 0.5*       CL*W
        RES_BE  =         - 0.5*CHORD*            CL_BE *W
C
c        write(*,*)
c        write(*,*) psi*180/pi, wa, wt
c        write(*,*) beta*180/pi,ATAN2(WA,WT)*180/pi,a*180/pi
c        write(*,*) w, w_psi, w_vel, w_omg
c        Write(*,*) cl, cl_psi, cl_vel, cl_omg
c        Write(*,*) res, res_psi, res_vel, res_omg
c        pause

C------ Newton change
        DPSI = -RES/RES_PSI
        DPSI = MAX( -0.1 , MIN ( 0.1 , DPSI ) )

c        if(iter.gt.10) then
c          write(*,9922) iter, r, cl, psi, dpsi
c 9922     format(1x,i4, 3f12.5, e13.4)
c        endif

C------ exit if converged
        IF(ABS(DPSI) .LT. EPS) THEN
         LCONV = .TRUE.
         GO TO 50
        ENDIF
C
C------ Newton update
        PSI = PSI + DPSI
      ENDDO
      WRITE(*,*) &#39;GVCALC: Not converged.  Res a CL =&#39;, RES, A, CL
C
C-----------------
 50   CONTINUE
C
C---- set PSI derivatives w.r.t. input parameters using  d(RES)=0  condition
      PSI_VEL = -RES_VEL/RES_PSI
      PSI_OMG = -RES_OMG/RES_PSI
      PSI_CH  = -RES_CH /RES_PSI
      PSI_BE  = -RES_BE /RES_PSI
C
C---- set derivatives of all outputs
      GAM_VEL = GAM_VEL + GAM_PSI*PSI_VEL
      GAM_OMG = GAM_OMG + GAM_PSI*PSI_OMG
      GAM_CH  =           GAM_PSI*PSI_CH
      GAM_BE  =           GAM_PSI*PSI_BE
C
      VA_VEL = VA_VEL + VA_PSI*PSI_VEL
      VA_OMG = VA_OMG + VA_PSI*PSI_OMG
      VA_CH  =          VA_PSI*PSI_CH
      VA_BE  =          VA_PSI*PSI_BE
C
      VT_VEL = VT_VEL + VT_PSI*PSI_VEL
      VT_OMG = VT_OMG + VT_PSI*PSI_OMG
      VT_CH  =          VT_PSI*PSI_CH
      VT_BE  =          VT_PSI*PSI_BE
C
      CL_VEL = CL_VEL + CL_PSI*PSI_VEL
      CL_OMG = CL_OMG + CL_PSI*PSI_OMG
      CL_CH  =          CL_PSI*PSI_CH
      CL_BE  = CL_BE  + CL_PSI*PSI_BE
C
      RETURN
      END ! GVCALC

</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./qprop"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="cdfun_f.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">cdfun.f</p>
      </div>
    </a>
    <a class="right-next"
       href="spline_f.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">spline.f</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psi-iteration">Psi Iteration</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Roie R. Black
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>